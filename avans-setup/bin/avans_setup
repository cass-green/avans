#!/usr/bin/env python

# I tested this script on Python 2.7.6

from string import Template
import sys
import re
import os

AVANS_VERSION = '0.37.1'

class AvansSetup:
    def __init__(self, pkg):
        self.package = pkg
        m = re.compile(r'\A(.*)\.([^.]*)$').match(pkg)
        if m:
            self.groupId = m.group(1)
            self.artifactId = m.group(2)
            self.project = m.group(2)
        else:
            self.fail("Invalid package name '%s'" % pkg)

    def fail(self, msg):
        print(msg)
        sys.exit(1)

    def run(self):
        if os.path.exists(self.project):
            self.fail("Directory is already exists: %s/" % self.project)

        java_dir = os.path.join(
                self.project, 'src', 'main', 'java',
                self.package.replace('.', '/'))

        os.makedirs(os.path.join(java_dir, 'controller'))
        os.makedirs(os.path.join(
                self.project, 'src', 'main', 'resources'))
        os.makedirs(os.path.join(
                self.project, 'src', 'main', 'resources', 'templates'))

        template_dir = os.path.join(
                os.path.abspath(os.path.dirname(__file__)),
                '..', 'templates'
                )

        print template_dir
        for root, dirnames, filenames in os.walk(template_dir):
            for filename in filenames:
                srcname = os.path.join(root, filename)
                destpath = os.path.relpath(srcname, template_dir)
                destpath = destpath.replace('PACKAGE', self.package.replace('.', '/'))
                self.renderFile(os.path.join(self.project, destpath), srcname)

        os.chdir(self.project)
        code = os.system('mvn test')
        if code != 0:
            self.fail("mvn test fail: %s" % code)
        print(open('README.md').read())

    def renderFile(self, dest, templatefilename):
        print "Rendering %s" % dest
        if not os.path.exists(os.path.dirname(dest)):
            os.makedirs(os.path.dirname(dest))
        src = open(templatefilename).read()
        src = src.replace('[% project %]', self.project)
        src = src.replace('[% package %]', self.package)
        src = src.replace('[% groupId %]', self.groupId)
        src = src.replace('[% artifactId %]', self.artifactId)
        src = src.replace('[% AVANS_VERSION %]', AVANS_VERSION)
        open(dest, 'w').write(src)

if len(sys.argv) != 2:
    print 'Usage: avans-setup.rb package.name'
    sys.exit(1)

package_name = sys.argv[1]

setup = AvansSetup(package_name)
setup.run()

