#!/usr/bin/env ruby

require 'fileutils'
require 'erb'
require 'pathname'

AVANS_VERSION = '0.27.9'

# Setup application class
class AvansSetup
  def initialize(pkg)
    @pkg = pkg # XXX Remove this
    @package = pkg
    if pkg =~ /\A(.*)\.(.*?)\z/
      @groupId = $1
      @artifactId = $2
      @project = $2
    else
      fail "Invalid package name: #{pkg}"
    end
  end

  def render(path)
    erb = ERB.new(File.read(path))
    result = erb.result(binding)
    result
  end

  def render_file(dest_path, template_file)
    FileUtils.mkdir_p(File.dirname(dest_path))
    puts "#{template_file} => #{dest_path}"
    File.write(dest_path, render(template_file))
  end

  def run
    if File.directory?(@project)
      fail "Directory is already exists: #{@project}/"
    end

    java_dir = "#{@project}/src/main/java/#{@pkg.gsub(/\./, '/')}"

    FileUtils.mkdir_p("#{java_dir}/controller/")
    FileUtils.mkdir_p("#{@project}/src/main/resources/")
    FileUtils.mkdir_p("#{@project}/templates/")

    template_dir = File.join(File.dirname(File.expand_path(__FILE__)),
                         "../templates/")
    Dir.glob("#{template_dir}/**/*").select do |it|
      File.file?(it)
    end.each do |file|
      destpath = Pathname.new(file).relative_path_from(Pathname.new(template_dir))
      destpath = destpath.to_s.gsub(/PACKAGE/, @pkg.gsub(/\./, '/'))
      render_file("#{@project}/#{destpath}", file)
    end

    Dir.chdir(@project)
    system('mvn package')

    puts File.read('README.md')
  end
end

if ARGV.length != 1
  puts 'Usage: avans-setup.rb package.name'
  exit
end

package_name = ARGV[0]

setup = AvansSetup.new(package_name)
setup.run
